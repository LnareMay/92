<!DOCTYPE html>
<html lang="ko-KR" xmlns:th="http://www.thymeleaf.org">

<head>
	<!-- meta_tag include -->

	<head th:insert="~{layouts/meta_tag :: headMeta}"></head>
	<title>FITLINK</title>
	<!-- 공통 css -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.3/litera/bootstrap.min.css"
		integrity="sha512-TUtnNUXMMWp2IALAR9t2z1vuorOUQL4dPWG3J9ANInEj6xu/rz5fzni/faoEGzuqeY1Z1yGD6COYAW72oiDVYA=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link rel="stylesheet" th:href="@{/css/common.css}">
	<link rel="stylesheet" th:href="@{/css/detail_hj.css}"/>
	<link rel="stylesheet" th:href="@{/css/detail_yj.css}"/>

	<!-- 공통 js -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
		crossorigin="anonymous"></script>
		<script type="text/javascript"
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3cd1cbb83ed8cd66805a1d9f6fd57a32&libraries=services"></script>
</head>

<body>
	<!-- Header -->
	<div th:insert="~{layouts/header :: header}"></div>

	<!-- Main Content -->
	    <main class="container mt-4" id="facility_main_pg">

			<button type="button" class="public-btn" onclick="location.href='/facility/main'" >사설시설</button>
			<button type="button" class="region-btn"  data-bs-toggle="modal" data-bs-target="#mapModal">
				<i class="bi bi-geo-alt"></i></button>
			
				<div id="mapModal" class="modal fade" tabindex="-1">
					 <div class="modal-dialog">
				        <div class="modal-content">
				            <div class="modal-header">
				                <h5 class="modal-title">15km 이내 시설 위치</h5>
				                <button type="button" id="close-btn" class="btn-close" data-bs-dismiss="modal"></button>
				            </div>
				            <div class="modal-body">
				                <div id="map" style="width: 100%; height: 400px;"></div>
				            </div>
				        </div>
				    </div>
				</div>			

		<!-- 시설 목록 START -->
		<div th:if="${responseDTO.dtoList == null || responseDTO.dtoList.isEmpty()}">등록된 시설이 없습니다.</div>
		<div class="container mt-4">
			<div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4">
				<div class="col" th:each="facility : ${responseDTO.dtoList}">
					 <div class="card h-100" style="padding-top:40px;" th:onclick="|location.href='@{/facility/detail/{facilityCode}(facilityCode=${facility.facilityCode})}'|">
						<!-- <div class="img_wrap">
							<img class="card-img-top" th:src="|/view/${facility.facilityImage1}|" id="facilityImage1" alt="Product Image"
							onerror="this.src='https://placehold.co/80'">
						</div> -->
						<div class="card-body">
							<div class="tag">
								<td th:switch="${facility.exerciseCode}">
									<span th:case="'EXE_FOOTBALL'">축구장</span>
									<span th:case="'EXE_BASKET'">농구장</span>
									<span th:case="'EXE_BADMINTON'">배드민턴장</span>
									<span th:case="'EXE_CLIMB'">암벽등반장</span>
									<span th:case="'EXE_FUTSAL'">풋살장</span>
									<span th:case="'EXE_BASEBALL'">야구장</span>
									<span th:case="'EXE_YOGA'">요가</span>
									<span th:case="'EXE_TENNIS'">테니스장</span>
									<span th:case="'EXE_PILATES'">필라테스</span>
									<span th:case="'EXE_FITNESS'">헬스장</span>
									<span th:case="*">NULL</span>
								</td>
							</div>							
							<div class="ReservationOnlyClubtag" th:if="${facility.facilityIsOnlyClub}">
								<span>클럽전용</span>
							</div>
							<h7 th:text="${facility.facilityAddress}" class="card-text"></h7>
							<h5 th:text="${facility.facilityName}" class="card-title"></h5>
							<p th:text="${facility.formattedPrice}" class="card-text"></p>
						</div>
					</div>
				</div>
			</div>
			<nav th:if="${!responseDTO.dtoList.isEmpty()}" 
				aria-label="Page navigation" class="mt-3">
			    <ul class="pagination justify-content-center">
			        <!-- 이전 페이지 버튼 -->
			        <li class="page-item" th:classappend="${responseDTO.page == 1} ? 'disabled'">
			            <a class="page-link" aria-label="Previous"
 						 th:href="@{|/facility/main_public?facilityAddress=${facilityAddress}&exerciseCode=${exerciseCode}&page=${responseDTO.page-1}|}">
			                «
			            </a>
			           <!-- th:href="@{'/facility/main'(facilityAddress=${facilityAddress}, exerciseCode=${exerciseCode}, page=${responseDTO.page - 1})}"> -->
			        </li>
			
			        <!-- 페이지 번호 -->
			        <th:block 
			        	th:each="i : ${#numbers.sequence(responseDTO.start, responseDTO.end)}">
				        <li class="page-item" 
				            th:classappend="${responseDTO.page == i} ? 'active'">
				            <a class="page-link" 
							th:href="@{|/facility/main_public?facilityAddress=${facilityAddress}&exerciseCode=${exerciseCode}&page=${i}|}">[[${i}]]</a>
				        </li>
				    </th:block>
			
			        <!-- 다음 페이지 버튼 -->
			        <li class="page-item" th:classappend="${responseDTO.page == responseDTO.end} ? 'disabled'">
			            <a class="page-link" aria-label="Next"
						th:href="@{|/facility/main_public?facilityAddress=${facilityAddress}&exerciseCode=${exerciseCode}&page=${responseDTO.page + 1}|}">
			                »
			            </a>
			        </li>
			    </ul>
			</nav>
		</div>
		<!-- 시설 목록 END -->
	</main>
	<!-- Footer -->
	<div th:insert="~{layouts/footer :: footer}"></div>
</body>

<script>
      
		let map;
		let userMarker; //사용자 위치 마커
		let userLat, userLng;
		
		document.getElementById("mapModal").addEventListener("shown.bs.modal", () => {
			initMap();
		});

		function initMap() {
			map = new kakao.maps.Map(document.getElementById("map"), {
				center: new kakao.maps.LatLng(37.5665, 126.9780),
				level: 9
			});			
			
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(position => {
					userLat = position.coords.latitude;
					userLng = position.coords.longitude;
					
					let userLocation = new kakao.maps.LatLng(userLat, userLng);
					map.setCenter(userLocation);
					
					new kakao.maps.Marker({
						map: map, 
						position: userLocation,
						title: "내 위치",
						image: new kakao.maps.MarkerImage(
						        "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",  
						        new kakao.maps.Size(32, 32), // 아이콘 크기
						        { offset: new kakao.maps.Point(16, 32) } // 중심 위치
						    ) 
					});
					fetchFacilities(userLat, userLng);
				});
			} else {
				alert("위치 정보를 가져올 수 없습니다.")
			}
		}		
		
		function fetchFacilities(lat, longt) {
			console.log("보내는 lat, longt:", lat, longt);
			fetch(`/facility/search?lat=${lat}&longt=${longt}&radius=15`) // 15km
				.then(res => res.json())
				.then(facilities=> {
					console.log(facilities);
					facilities.forEach(facility => addFacilityMarker(facility));
			})
		} 

		function addFacilityMarker(facility) {
			let coords = new kakao.maps.LatLng(facility.facilityLat, facility.facilityLongt);
			
			let marker = new kakao.maps.Marker({
				map: map,
				position: coords
			});
			
			let infowindow = new kakao.maps.InfoWindow({
				content: `<div style="padding: 5px; font-size: 11px; font-weight: bold; color: #333;">
							${facility.facilityName}<br>
							<span style="font-size: 10px; color: #666;">${facility.facilityAddress}</span>
						  </div>`
			});
			
			kakao.maps.event.addListener(marker, 'mouseover', () => {
				infowindow.open(map, marker);
			});

			kakao.maps.event.addListener(marker, 'mouseout', () => {
				infowindow.close();
			});
		}

		
		window.addEventListener("resize", () => {
		    if (map) {
		        map.relayout(); // 지도 크기 변경 적용
		        let userLocation = new kakao.maps.LatLng(userLat, userLng);
		        map.setCenter(userLocation); // 지도 중심을 사용자 위치로 재설정
		        
		        if (userMarker) {
		            userMarker.setPosition(userLocation); // 사용자 마커 위치 업데이트
		        }
		    }
		});		

</script>

</body>

</html>
